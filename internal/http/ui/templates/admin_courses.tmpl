{{define "admin-courses"}}
  {{template "layout" .}}
{{end}}

{{define "content"}}
<div class="space-y-6">
  <!-- Page header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-slate-900">Gestion des cours</h1>
      <p class="mt-1 text-sm text-slate-600">Cr√©ez et g√©rez vos parcours p√©dagogiques</p>
    </div>
    <a href="/admin?org={{.SelectedOrg}}" class="rounded-lg bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-200">
      ‚Üê Retour au tableau de bord
    </a>
  </div>

  <!-- Create new course card -->
  <section class="rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 p-8 ring-1 ring-blue-100">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Cr√©er un nouveau cours</h2>
        <p class="mt-1 text-sm text-slate-600">Utilisez l'assistant guid√© pour cr√©er un cours complet en quelques √©tapes</p>
      </div>
      <div class="text-5xl">‚ú®</div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <!-- Wizard option (recommended) -->
      <a
        href="/admin/courses/new?org={{.SelectedOrg}}"
        class="group relative overflow-hidden rounded-lg bg-gradient-to-br from-blue-600 to-indigo-700 p-6 text-white hover:from-blue-700 hover:to-indigo-800 transition-all shadow-lg hover:shadow-xl"
      >
        <div class="absolute top-0 right-0 text-6xl opacity-10">üßô</div>
        <div class="relative">
          <div class="text-3xl mb-3">üöÄ</div>
          <h3 class="text-lg font-bold mb-2">Assistant de cr√©ation guid√©</h3>
          <p class="text-sm text-blue-100 mb-4">
            Interface pas √† pas pour cr√©er un cours complet avec modules et contenus
          </p>
          <div class="inline-flex items-center gap-2 text-sm font-semibold">
            <span>Commencer ‚Üí</span>
          </div>
          <div class="mt-4 pt-4 border-t border-white/20">
            <div class="flex items-center gap-2 text-xs text-blue-100">
              <span>‚úì 3 √©tapes simples</span>
              <span>‚Ä¢</span>
              <span>‚úì Templates inclus</span>
              <span>‚Ä¢</span>
              <span>‚úì Drag & drop</span>
            </div>
          </div>
        </div>
      </a>

      <!-- Quick create option -->
      <div class="rounded-lg bg-white p-6 ring-1 ring-slate-200">
        <div class="text-3xl mb-3">‚ö°</div>
        <h3 class="text-lg font-bold text-slate-900 mb-2">Cr√©ation rapide</h3>
        <p class="text-sm text-slate-600 mb-4">
          Cr√©ez uniquement le cours, ajoutez les modules plus tard
        </p>
        <form class="space-y-3" method="post" action="/admin/courses">
          <input type="hidden" name="org_id" value="{{.SelectedOrg}}" />
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1" for="course-title">Titre du cours *</label>
            <input
              id="course-title"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              name="title"
              placeholder="Ex: Introduction au marketing digital"
              required
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1" for="course-description">Description</label>
            <input
              id="course-description"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              name="description"
              placeholder="R√©sum√© du parcours"
            />
          </div>
          <button class="w-full rounded-lg bg-slate-700 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" type="submit">
            Cr√©er le cours
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Courses list -->
  <section class="space-y-4">
    <h2 class="text-xl font-semibold text-slate-900">Mes cours ({{len .Courses}})</h2>

    {{if .Courses}}
      {{range .Courses}}
      <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-slate-200 hover:shadow-md transition-shadow">
        <!-- Course header -->
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <h3 class="text-xl font-semibold text-slate-900">{{.Course.Title}}</h3>
              {{if eq .Course.Status "published"}}
                <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                  Publi√©
                </span>
              {{else if eq .Course.Status "draft"}}
                <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600">
                  Brouillon
                </span>
              {{else}}
                <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
                  {{.Course.Status}}
                </span>
              {{end}}
            </div>
            <p class="mt-1 text-sm text-slate-600">{{if .Course.Description}}{{.Course.Description}}{{else}}Aucune description{{end}}</p>
            <div class="mt-2 flex items-center gap-4 text-xs text-slate-500">
              <span>Slug: <span class="font-mono text-slate-700">{{.Course.Slug}}</span></span>
              <span>‚Ä¢</span>
              <span>{{len .Modules}} module(s)</span>
              <span>‚Ä¢</span>
              <span>{{.EnrollmentCount}} inscription(s)</span>
            </div>
          </div>

          <!-- Course actions -->
          <div class="flex items-center gap-2">
            {{if eq .Course.Status "draft"}}
              <form method="post" action="/admin/courses/{{.Course.ID}}/publish?org={{$.SelectedOrg}}" class="inline">
                <button type="submit" class="rounded-lg bg-green-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-green-700">
                  Publier
                </button>
              </form>
            {{else if eq .Course.Status "published"}}
              <form method="post" action="/admin/courses/{{.Course.ID}}/unpublish?org={{$.SelectedOrg}}" class="inline">
                <button type="submit" class="rounded-lg bg-slate-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-slate-700">
                  D√©publier
                </button>
              </form>
            {{end}}

            <button
              onclick="toggleEditCourse('{{.Course.ID}}')"
              class="rounded-lg bg-blue-100 px-3 py-1.5 text-xs font-medium text-blue-700 hover:bg-blue-200"
            >
              Modifier
            </button>

            <form method="post" action="/admin/courses/{{.Course.ID}}/delete?org={{$.SelectedOrg}}" class="inline" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce cours ?')">
              <button type="submit" class="rounded-lg bg-red-100 px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-200">
                Supprimer
              </button>
            </form>
          </div>
        </div>

        <!-- Edit course form (hidden by default) -->
        <div id="edit-course-{{.Course.ID}}" class="mt-4 hidden rounded-lg bg-slate-50 p-4">
          <h4 class="text-sm font-semibold text-slate-900">Modifier le cours</h4>
          <form class="mt-3 grid gap-3 md:grid-cols-2" method="post" action="/admin/courses/{{.Course.ID}}/update?org={{$.SelectedOrg}}">
            <div>
              <label class="block text-sm font-medium text-slate-700" for="edit-title-{{.Course.ID}}">Titre</label>
              <input
                id="edit-title-{{.Course.ID}}"
                class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                name="title"
                value="{{.Course.Title}}"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700" for="edit-description-{{.Course.ID}}">Description</label>
              <input
                id="edit-description-{{.Course.ID}}"
                class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                name="description"
                value="{{.Course.Description}}"
              />
            </div>
            <div class="md:col-span-2 flex gap-2 justify-end">
              <button type="button" onclick="toggleEditCourse('{{.Course.ID}}')" class="rounded-lg bg-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-300">
                Annuler
              </button>
              <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">
                Enregistrer
              </button>
            </div>
          </form>
        </div>

        <!-- Modules section -->
        <div class="mt-6 border-t border-slate-200 pt-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-sm font-semibold text-slate-900">Modules du cours</h4>
            <button
              onclick="toggleAddModule('{{.Course.ID}}')"
              class="rounded-lg bg-indigo-100 px-3 py-1.5 text-xs font-medium text-indigo-700 hover:bg-indigo-200"
            >
              + Ajouter un module
            </button>
          </div>

          <!-- Add module form (hidden by default) -->
          <div id="add-module-{{.Course.ID}}" class="mb-4 hidden rounded-lg bg-indigo-50 p-4">
            <h5 class="text-sm font-semibold text-slate-900">Nouveau module</h5>
            <form class="mt-3 grid gap-3 md:grid-cols-4" method="post" action="/admin/modules?org={{$.SelectedOrg}}">
              <input type="hidden" name="org_id" value="{{$.SelectedOrg}}" />
              <input type="hidden" name="course_id" value="{{.Course.ID}}" />
              <div>
                <label class="block text-xs font-medium text-slate-700" for="module-title-{{.Course.ID}}">Titre du module *</label>
                <input
                  id="module-title-{{.Course.ID}}"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-sm"
                  name="title"
                  placeholder="Introduction"
                  required
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700" for="module-type-{{.Course.ID}}">Type *</label>
                <select
                  id="module-type-{{.Course.ID}}"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-sm"
                  name="module_type"
                  required
                >
                  <option value="">Choisir...</option>
                  {{range $.ModuleTypes}}
                  <option value="{{.}}">{{.}}</option>
                  {{end}}
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700" for="module-content-{{.Course.ID}}">Contenu</label>
                <select
                  id="module-content-{{.Course.ID}}"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-sm"
                  name="content_id"
                >
                  <option value="">Aucun</option>
                  {{range $.Contents}}
                  <option value="{{.ID}}">{{.Name}} ({{.MimeType}})</option>
                  {{end}}
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700" for="module-duration-{{.Course.ID}}">Dur√©e (sec)</label>
                <input
                  id="module-duration-{{.Course.ID}}"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-2.5 py-1.5 text-sm"
                  name="duration"
                  type="number"
                  min="0"
                  placeholder="300"
                />
              </div>
              <div class="md:col-span-4 flex gap-2 justify-end">
                <button type="button" onclick="toggleAddModule('{{.Course.ID}}')" class="rounded-lg bg-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-300">
                  Annuler
                </button>
                <button type="submit" class="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-700">
                  Ajouter
                </button>
              </div>
            </form>
          </div>

          <!-- Modules list -->
          {{if .Modules}}
            <div class="space-y-2">
              {{range .Modules}}
              <div class="flex items-center justify-between rounded-lg bg-slate-50 px-4 py-3 text-sm">
                <div class="flex items-center gap-3">
                  <span class="flex h-7 w-7 items-center justify-center rounded-full bg-slate-200 text-xs font-semibold text-slate-700">
                    {{.Position | printf "%02d"}}
                  </span>
                  <div>
                    <p class="font-medium text-slate-900">{{.Title}}</p>
                    <p class="text-xs text-slate-500">
                      Type: <span class="font-mono">{{.ModuleType}}</span>
                      {{if .DurationSeconds}} ‚Ä¢ Dur√©e: {{.DurationSeconds}}s{{end}}
                      {{if .ContentID}} ‚Ä¢ Avec contenu{{end}}
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    onclick="toggleEditModule('{{.ID}}')"
                    class="rounded bg-blue-100 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-200"
                  >
                    Modifier
                  </button>
                  <form method="post" action="/admin/modules/{{.ID}}/delete?org={{$.SelectedOrg}}" class="inline" onsubmit="return confirm('Supprimer ce module ?')">
                    <button type="submit" class="rounded bg-red-100 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-200">
                      Supprimer
                    </button>
                  </form>
                </div>
              </div>

              <!-- Edit module form (hidden by default) -->
              <div id="edit-module-{{.ID}}" class="hidden rounded-lg bg-blue-50 p-3 ml-10">
                <form class="grid gap-2 md:grid-cols-4" method="post" action="/admin/modules/{{.ID}}/update?org={{$.SelectedOrg}}">
                  <div>
                    <label class="block text-xs font-medium text-slate-700">Titre</label>
                    <input class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" name="title" value="{{.Title}}" required />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-700">Type</label>
                    <select class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" name="module_type" required>
                      {{range $.ModuleTypes}}
                      <option value="{{.}}" {{if eq . $.ModuleType}}selected{{end}}>{{.}}</option>
                      {{end}}
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-700">Contenu</label>
                    <select class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" name="content_id">
                      <option value="">Aucun</option>
                      {{range $.Contents}}
                      <option value="{{.ID}}">{{.Name}}</option>
                      {{end}}
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-700">Dur√©e (sec)</label>
                    <input class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" name="duration" type="number" value="{{.DurationSeconds}}" />
                  </div>
                  <div class="md:col-span-4 flex gap-2 justify-end">
                    <button type="button" onclick="toggleEditModule('{{.ID}}')" class="rounded bg-slate-200 px-3 py-1 text-xs font-medium text-slate-700">
                      Annuler
                    </button>
                    <button type="submit" class="rounded bg-blue-600 px-3 py-1 text-xs font-semibold text-white hover:bg-blue-700">
                      Enregistrer
                    </button>
                  </div>
                </form>
              </div>
              {{end}}
            </div>
          {{else}}
            <p class="text-sm text-slate-500 italic">Aucun module dans ce cours pour le moment.</p>
          {{end}}
        </div>
      </div>
      {{end}}
    {{else}}
      <div class="rounded-xl bg-slate-50 p-12 text-center">
        <p class="text-slate-600">Aucun cours cr√©√© pour le moment.</p>
        <p class="mt-1 text-sm text-slate-500">Commencez par cr√©er votre premier cours ci-dessus.</p>
      </div>
    {{end}}
  </section>
</div>

<script>
function toggleEditCourse(courseId) {
  const form = document.getElementById('edit-course-' + courseId);
  if (form.classList.contains('hidden')) {
    form.classList.remove('hidden');
  } else {
    form.classList.add('hidden');
  }
}

function toggleAddModule(courseId) {
  const form = document.getElementById('add-module-' + courseId);
  if (form.classList.contains('hidden')) {
    form.classList.remove('hidden');
  } else {
    form.classList.add('hidden');
  }
}

function toggleEditModule(moduleId) {
  const form = document.getElementById('edit-module-' + moduleId);
  if (form.classList.contains('hidden')) {
    form.classList.remove('hidden');
  } else {
    form.classList.add('hidden');
  }
}
</script>
{{end}}
